generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String           @id
  name           String
  email          String
  emailVerified  Boolean
  image          String?
  createdAt      DateTime
  updatedAt      DateTime
  sessions       Session[]
  accounts       Account[]
  courses        Course[]
  enrollment     Enrollment[]
  lessonProgress LessonProgress[]

  stripeCustomerId String? @unique

  role       String?
  banned     Boolean?
  banReason  String?
  banExpires DateTime?

  // New marketplace relationships
  teacherProfile    TeacherProfile?
  studentSessions   LiveSession[]     @relation("StudentSessions")
  groupEnrollments  GroupEnrollment[] @relation("GroupEnrollments")
  reviewsGiven      Review[]          @relation("UserReviews")
  notifications     Notification[]    @relation("UserNotifications")
  sentMessages      Message[]         @relation("SentMessages")
  receivedMessages  Message[]         @relation("ReceivedMessages")
  certificates      Certificate[]     @relation("UserCertificates")
  
  // Conversations
  conversationsAsParticipant1 Conversation[] @relation("ConversationParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationParticipant2")
  
  // Blog
  blogPosts     BlogPost[]    @relation("BlogPosts")
  
  // AI Recommendations & Learning
  preferences              UserPreferences?
  interactions            UserInteraction[]
  recommendations         CourseRecommendation[]
  createdLearningPaths    LearningPath[]
  learningPathEnrollments LearningPathEnrollment[]
  
  // Quiz System
  createdQuizzes          Quiz[]
  quizAttempts            QuizAttempt[]
  
  // Whiteboard System
  createdWhiteboards      Whiteboard[]          @relation("WhiteboardCreator")
  whiteboardElements      WhiteboardElement[]
  whiteboardParticipation WhiteboardParticipant[] @relation("WhiteboardParticipants")

  // Video Conferencing System
  hostedRooms             VideoRoom[]           @relation("VideoRoomHost")
  videoParticipation      VideoParticipant[]    @relation("VideoParticipants")
  videoChatMessages       VideoChatMessage[]    @relation("VideoChatUsers")

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model Course {
  id String @id @default(uuid())

  title       String
  description String
  fileKey     String
  price       Int
  duration    Int
  level       CourseLevel @default(Beginner)

  stripePriceId String? @unique

  category         String
  smallDescription String
  slug             String @unique

  status CourseStatus @default(Draft)

  // New marketplace fields
  language         String?
  tags             String[]
  prerequisites    String?
  learningOutcomes String[]
  isFeatured       Boolean @default(false)
  discountPrice    Int?
  discountExpiry   DateTime?
  totalStudents    Int @default(0)
  averageRating    Float?
  totalReviews     Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  chapter       Chapter[]
  enrollment    Enrollment[]
  reviews       Review[]        @relation("CourseReviews")
  certificates  Certificate[]
  categoryModel Category?       @relation(fields: [categoryId], references: [id])
  categoryId    String?
  
  // AI Recommendations
  interactions     UserInteraction[]
  recommendations  CourseRecommendation[]
  
  // Quiz System
  quizzes          Quiz[]
  
  // Whiteboard System  
  whiteboards      Whiteboard[]
  
  // Video Conferencing
  videoRooms       VideoRoom[]
}

enum CourseLevel {
  Beginner
  Intermediate
  Advanced
}

enum CourseStatus {
  Draft
  Published
  Archived
}

model Chapter {
  id String @id @default(uuid())

  title    String
  position Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String

  lessons Lesson[]
  quizzes Quiz[]
  
  // Whiteboard System
  whiteboards Whiteboard[]
  
  // Video Conferencing
  videoRooms  VideoRoom[]
}

model Lesson {
  id String @id @default(uuid())

  title        String
  description  String?
  thumbnailKey String?
  videoKey     String?
  position     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  chapterId String

  lessonProgress LessonProgress[]
  quizzes        Quiz[]
  
  // Whiteboard System
  whiteboards    Whiteboard[]
  
  // Video Conferencing
  videoRooms     VideoRoom[]
}

model Enrollment {
  id String @id @default(uuid())

  amount Int
  status EnrollmentStatus @default(Pending)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@unique([userId, courseId])
}

enum EnrollmentStatus {
  Pending
  Active
  Cancelled
}

model LessonProgress {
  id String @id @default(uuid())

  completed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  User     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  Lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId String

  @@unique([userId, lessonId])
}

// New Marketplace Models

model TeacherProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio         String?
  expertise   String[] // Array of expertise areas
  languages   String[] // Languages taught
  hourlyRate  Int?     // Rate for live sessions in cents
  
  isVerified  Boolean  @default(false)
  isApproved  Boolean  @default(false)
  
  availability Json?   // Availability schedule
  timezone    String?
  
  totalEarnings Decimal @default(0)
  rating       Float?
  totalReviews Int     @default(0)
  totalStudents Int    @default(0)
  
  // Social links
  website     String?
  linkedin    String?
  twitter     String?
  youtube     String?
  
  // Verification documents
  qualifications String[]
  certifications String[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  liveSessions LiveSession[]
  groupClasses GroupClass[]
  reviews      Review[]      @relation("TeacherReviews")
  commissions  Commission[]
}

model LiveSession {
  id          String   @id @default(uuid())
  
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  studentId   String?
  student     User?    @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  subject     String?
  
  scheduledAt DateTime
  duration    Int      // Duration in minutes
  price       Int      // Price in cents
  
  status      SessionStatus @default(Scheduled)
  
  meetingUrl  String?
  recordingUrl String?
  notes       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GroupClass {
  id          String   @id @default(uuid())
  
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  subject     String?
  level       String?
  language    String?
  
  scheduledAt DateTime
  duration    Int      // Duration in minutes
  maxStudents Int      @default(20)
  price       Int      // Price per student in cents
  
  status      ClassStatus @default(Scheduled)
  
  meetingUrl  String?
  materials   String[] // Links to materials
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  enrollments GroupEnrollment[]
}

model GroupEnrollment {
  id        String     @id @default(uuid())
  
  classId   String
  class     GroupClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  studentId String
  student   User       @relation("GroupEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  
  enrolledAt DateTime @default(now())
  
  @@unique([classId, studentId])
}

model Review {
  id        String   @id @default(uuid())
  
  // For course reviews
  courseId  String?
  course    Course?  @relation("CourseReviews", fields: [courseId], references: [id], onDelete: Cascade)
  
  // For teacher reviews
  teacherId String?
  teacher   TeacherProfile? @relation("TeacherReviews", fields: [teacherId], references: [id], onDelete: Cascade)
  
  reviewerId String
  reviewer   User     @relation("UserReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  
  rating    Int      @db.SmallInt // 1-5 stars
  title     String?
  comment   String?
  
  isVerified Boolean @default(false)
  isHelpful  Int     @default(0) // Helpfulness votes
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  image       String?
  
  parentId    String?
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0)
  
  courses     Course[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  color     String?
  
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Commission {
  id          String   @id @default(uuid())
  
  teacherId   String
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Commission source
  courseId    String?
  sessionId   String?
  
  type        CommissionType
  amount      Int      // Amount in cents
  commission  Int      // Commission amount in cents
  netAmount   Int      // Amount after commission in cents
  
  status      PayoutStatus @default(Pending)
  
  paidAt      DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  
  title     String
  message   String
  type      NotificationType
  
  isRead    Boolean  @default(false)
  
  // Optional data for different notification types
  data      Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id            String   @id @default(uuid())
  
  // Participants
  participant1Id String
  participant1   User     @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  
  participant2Id String
  participant2   User     @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  
  // Conversation metadata
  title         String?
  isGroup       Boolean  @default(false)
  
  // Last message info for quick access
  lastMessageId String? @unique
  lastMessage   Message? @relation("ConversationLastMessage", fields: [lastMessageId], references: [id])
  lastActivity  DateTime @default(now())
  
  // Messages in this conversation
  messages      Message[] @relation("ConversationMessages")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([participant1Id, participant2Id])
}

model Message {
  id          String   @id @default(uuid())
  
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId  String
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  conversationId String
  conversation   Conversation @relation("ConversationMessages", fields: [conversationId], references: [id], onDelete: Cascade)
  
  content     String
  messageType MessageType @default(Text)
  
  // File attachments
  attachments Json?
  
  isRead      Boolean  @default(false)
  isEdited    Boolean  @default(false)
  
  // Optional: message thread (for replies)
  parentId    String?
  parent      Message? @relation("MessageThread", fields: [parentId], references: [id])
  replies     Message[] @relation("MessageThread")
  
  // Conversation last message reference
  conversationLastMessage Conversation? @relation("ConversationLastMessage")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Certificate {
  id          String   @id @default(uuid())
  
  userId      String
  user        User     @relation("UserCertificates", fields: [userId], references: [id], onDelete: Cascade)
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  certificateNumber String @unique
  templateId  String?
  
  issuedAt    DateTime @default(now())
  
  // Certificate data
  studentName String
  courseName  String
  teacherName String
  completionDate DateTime
  
  // Verification
  verificationUrl String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogPost {
  id          String   @id @default(uuid())
  
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  
  authorId    String
  author      User     @relation("BlogPosts", fields: [authorId], references: [id], onDelete: Cascade)
  
  categoryId  String?
  category    BlogCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  tags        BlogTag[] @relation("BlogPostTags")
  
  featuredImage String?
  
  isPublished Boolean  @default(false)
  publishedAt DateTime?
  
  views       Int      @default(0)
  likes       Int      @default(0)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogCategory {
  id          String   @id @default(uuid())
  
  name        String   @unique
  slug        String   @unique
  description String?
  color       String?
  
  posts       BlogPost[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BlogTag {
  id          String   @id @default(uuid())
  
  name        String   @unique
  slug        String   @unique
  color       String?
  
  posts       BlogPost[] @relation("BlogPostTags")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Enums

enum SessionStatus {
  Scheduled
  InProgress
  Completed
  Cancelled
  NoShow
}

enum ClassStatus {
  Scheduled
  InProgress
  Completed
  Cancelled
}

enum CommissionType {
  Course
  LiveSession
  GroupClass
}

enum PayoutStatus {
  Pending
  Processing
  Paid
  Failed
}

enum NotificationType {
  System
  Course
  Session
  Payment
  Review
  Message
}

enum MessageType {
  Text
  Image
  File
  Video
  Audio
}

enum QuestionType {
  MultipleChoice
  TrueFalse
  ShortAnswer
  LongAnswer
  FillInTheBlank
  Matching
  Ordering
  Drag
}

enum DifficultyLevel {
  Easy
  Medium
  Hard
  Expert
}

enum AttemptStatus {
  InProgress
  Completed
  Submitted
  Graded
  Failed
}

enum InteractionType {
  View
  Enroll
  Complete
  Search
  Like
  Share
  Download
  Rate
  Comment
}

enum LearningStyle {
  Visual
  Auditory
  Kinesthetic
  Reading
}

enum TimeAvailability {
  Low
  Medium
  High
}

enum ElementType {
  Pen           // Free drawing
  Line          // Straight line
  Rectangle     // Rectangle shape
  Circle        // Circle/Ellipse
  Arrow         // Arrow
  Text          // Text element
  Image         // Image element
  Sticky        // Sticky note
  Shape         // Complex shapes
  Highlight     // Highlighter
  Eraser        // Eraser strokes
}

enum ParticipantRole {
  Owner         // Full control
  Moderator     // Can moderate and draw
  Collaborator  // Can draw and edit
  Viewer        // Can only view
}

model UserPreferences {
  id               String            @id @default(cuid())
  userId           String            @unique
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  categories       String[]          // Preferred categories
  difficulty       String[]          // Preferred difficulty levels
  priceRangeMin    Float?            @default(0)
  priceRangeMax    Float?            @default(1000)
  learningStyle    LearningStyle     @default(Visual)
  timeAvailability TimeAvailability  @default(Medium)
  goals            String[]          // Learning goals
  topics           String[]          // Interested topics
  languages        String[]          // Preferred content languages
  notifications    Boolean           @default(true)
  
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@map("user_preferences")
}

model UserInteraction {
  id           String          @id @default(cuid())
  userId       String
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         InteractionType
  courseId     String?
  course       Course?         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category     String?
  searchQuery  String?
  duration     Int?            // Duration in seconds
  metadata     Json?           // Additional interaction data
  timestamp    DateTime        @default(now())
  
  @@map("user_interactions")
  @@index([userId, timestamp])
  @@index([courseId])
  @@index([type])
}

model CourseRecommendation {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId     String
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  confidence   Float    // 0-100 confidence score
  reasons      String[] // Reasons for recommendation
  tags         String[] // Recommendation tags
  algorithm    String   // Algorithm used for recommendation
  viewed       Boolean  @default(false)
  clicked      Boolean  @default(false)
  enrolled     Boolean  @default(false)
  
  createdAt    DateTime @default(now())
  expiresAt    DateTime // Recommendations expire after some time
  
  @@unique([userId, courseId])
  @@map("course_recommendations")
  @@index([userId, createdAt])
  @@index([expiresAt])
}

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String
  difficulty  String
  estimatedDuration Int? // Total duration in minutes
  courses     Json     // Ordered array of course IDs
  prerequisites Json?  // Prerequisites for each course
  tags        String[]
  isPublic    Boolean  @default(true)
  
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  
  enrollments LearningPathEnrollment[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("learning_paths")
}

model LearningPathEnrollment {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningPathId String
  learningPath  LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  
  progress      Json         // Progress tracking for each course
  currentCourse String?      // Currently active course ID
  completedAt   DateTime?
  
  enrolledAt    DateTime     @default(now())
  
  @@unique([userId, learningPathId])
  @@map("learning_path_enrollments")
}

model Quiz {
  id            String       @id @default(cuid())
  title         String
  description   String?
  instructions  String?
  
  courseId      String?
  course        Course?      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapterId     String?
  chapter       Chapter?     @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lessonId      String?
  lesson        Lesson?      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  createdById   String
  createdBy     User         @relation(fields: [createdById], references: [id])
  
  // Quiz Settings
  timeLimit     Int?         // Time limit in minutes
  passingScore  Int          @default(70) // Percentage needed to pass
  maxAttempts   Int          @default(3)  // Maximum attempts allowed
  showResults   Boolean      @default(true) // Show results immediately
  showCorrectAnswers Boolean @default(false) // Show correct answers after completion
  randomizeQuestions Boolean @default(false) // Randomize question order
  randomizeOptions Boolean   @default(false) // Randomize answer options
  
  // Scheduling
  availableFrom DateTime?    // When quiz becomes available
  availableTo   DateTime?    // When quiz stops being available
  
  // Status
  isPublished   Boolean      @default(false)
  isActive      Boolean      @default(true)
  
  // Relationships
  questions     QuizQuestion[]
  attempts      QuizAttempt[]
  analytics     QuizAnalytics?
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("quizzes")
}

model QuizQuestion {
  id            String       @id @default(cuid())
  quizId        String
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  type          QuestionType
  question      String       // The question text
  explanation   String?      // Explanation shown after answering
  points        Int          @default(1) // Points awarded for correct answer
  difficulty    DifficultyLevel @default(Medium)
  
  // Question ordering
  position      Int
  
  // Question data (stored as JSON for flexibility)
  questionData  Json         // Contains options, correct answers, etc.
  
  // Settings
  isRequired    Boolean      @default(true)
  partialCredit Boolean      @default(false) // Allow partial credit for multi-part questions
  
  // Relationships
  responses     QuizResponse[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("quiz_questions")
  @@index([quizId, position])
}

model QuizAttempt {
  id            String       @id @default(cuid())
  quizId        String
  quiz          Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Attempt details
  attemptNumber Int          // 1st attempt, 2nd attempt, etc.
  status        AttemptStatus @default(InProgress)
  
  // Scoring
  totalPoints   Int          @default(0)
  maxPoints     Int          @default(0)
  percentage    Float        @default(0)
  passed        Boolean      @default(false)
  
  // Timing
  startedAt     DateTime     @default(now())
  submittedAt   DateTime?
  timeSpent     Int?         // Time spent in seconds
  
  // Settings at time of attempt (snapshot)
  timeLimit     Int?
  passingScore  Int
  
  // Data
  responses     QuizResponse[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@unique([quizId, userId, attemptNumber])
  @@map("quiz_attempts")
  @@index([userId, createdAt])
}

model QuizResponse {
  id            String       @id @default(cuid())
  attemptId     String
  attempt       QuizAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId    String
  question      QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // Response data
  answer        Json         // Student's answer (flexible format)
  isCorrect     Boolean      @default(false)
  pointsAwarded Float        @default(0)
  timeTaken     Int?         // Time taken for this question in seconds
  
  // Feedback
  feedback      String?      // Automated or manual feedback
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@unique([attemptId, questionId])
  @@map("quiz_responses")
}

model QuizAnalytics {
  id            String   @id @default(cuid())
  quizId        String   @unique
  quiz          Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  // Participation stats
  totalAttempts Int      @default(0)
  uniqueUsers   Int      @default(0)
  
  // Performance stats
  averageScore  Float    @default(0)
  passRate      Float    @default(0)
  averageTime   Int      @default(0) // Average completion time in seconds
  
  // Question analytics
  questionStats Json     // Per-question statistics
  
  // Difficulty analysis
  difficultyDistribution Json // Distribution of question difficulties
  
  lastCalculated DateTime @default(now())
  
  @@map("quiz_analytics")
}

// Whiteboard Models
model Whiteboard {
  id          String   @id @default(cuid())
  title       String
  description String?
  
  // Association
  courseId    String?
  chapterId   String?
  lessonId    String?
  sessionId   String?
  
  // Whiteboard settings
  isPublic    Boolean  @default(false)
  isLocked    Boolean  @default(false)
  
  // Permissions
  allowDrawing    Boolean @default(true)
  allowText       Boolean @default(true)
  allowShapes     Boolean @default(true)
  allowImages     Boolean @default(true)
  allowAnnotations Boolean @default(true)
  
  // Canvas settings
  width       Int      @default(1920)
  height      Int      @default(1080)
  backgroundColor String @default("#ffffff")
  
  // Collaboration
  maxParticipants Int?
  
  createdById String
  createdBy   User     @relation("WhiteboardCreator", fields: [createdById], references: [id])
  
  // Relations
  course      Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter     Chapter? @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  elements    WhiteboardElement[]
  sessions    WhiteboardSession[]
  participants WhiteboardParticipant[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("whiteboards")
}

model WhiteboardElement {
  id            String    @id @default(cuid())
  whiteboardId  String
  whiteboard    Whiteboard @relation(fields: [whiteboardId], references: [id], onDelete: Cascade)
  
  // Element identification
  elementId     String    // Unique ID for real-time sync
  type          ElementType
  
  // Position and size
  x             Float
  y             Float
  width         Float?
  height        Float?
  
  // Styling
  strokeColor   String    @default("#000000")
  fillColor     String?
  strokeWidth   Float     @default(2)
  opacity       Float     @default(1)
  
  // Element-specific data
  data          Json      // Flexible data for different element types
  
  // Versioning for collaboration
  version       Int       @default(1)
  
  // Metadata
  createdById   String
  createdBy     User      @relation(fields: [createdById], references: [id])
  
  isDeleted     Boolean   @default(false)
  deletedAt     DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([whiteboardId, elementId])
  @@map("whiteboard_elements")
}

model WhiteboardSession {
  id           String    @id @default(cuid())
  whiteboardId String
  whiteboard   Whiteboard @relation(fields: [whiteboardId], references: [id], onDelete: Cascade)
  
  // Session info
  sessionName  String?
  isActive     Boolean   @default(true)
  
  // Permissions for this session
  canDraw      Boolean   @default(true)
  canEdit      Boolean   @default(false)
  canDelete    Boolean   @default(false)
  
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  
  // Session participants
  participants WhiteboardParticipant[]
  
  @@map("whiteboard_sessions")
}

model WhiteboardParticipant {
  id           String    @id @default(cuid())
  
  whiteboardId String
  whiteboard   Whiteboard @relation(fields: [whiteboardId], references: [id], onDelete: Cascade)
  
  sessionId    String?
  session      WhiteboardSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  
  userId       String
  user         User      @relation("WhiteboardParticipants", fields: [userId], references: [id])
  
  // Participant info
  role         ParticipantRole @default(Viewer)
  cursorColor  String    @default("#007bff")
  
  // Status
  isOnline     Boolean   @default(false)
  lastSeen     DateTime  @default(now())
  
  // Cursor position for real-time collaboration
  cursorX      Float?
  cursorY      Float?
  
  joinedAt     DateTime  @default(now())
  leftAt       DateTime?
  
  @@unique([whiteboardId, userId])
  @@map("whiteboard_participants")
}

// Video Conferencing System
model VideoRoom {
  id                    String            @id @default(cuid())
  roomId                String            @unique // Unique room identifier for WebRTC
  title                 String
  description           String?
  hostId                String
  courseId              String?
  chapterId             String?
  lessonId              String?
  
  // Scheduling
  scheduledFor          DateTime?
  duration              Int               @default(60) // minutes
  
  // Settings
  maxParticipants       Int?
  isRecordingEnabled    Boolean           @default(false)
  isScreenSharingEnabled Boolean          @default(true)
  isWhiteboardEnabled   Boolean           @default(true)
  isChatEnabled         Boolean           @default(true)
  isPrivate             Boolean           @default(false)
  waitingRoomEnabled    Boolean           @default(false)
  requireModerator      Boolean           @default(false)
  autoRecord            Boolean           @default(false)
  quality               VideoQuality      @default(MEDIUM)
  
  // State
  status                RoomStatus        @default(WAITING)
  startedAt             DateTime?
  endedAt               DateTime?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  host                  User              @relation("VideoRoomHost", fields: [hostId], references: [id], onDelete: Cascade)
  course                Course?           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter               Chapter?          @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  lesson                Lesson?           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  participants          VideoParticipant[]
  recordings            VideoRecording[]
  chatMessages          VideoChatMessage[]

  @@map("video_rooms")
}

model VideoParticipant {
  id                    String            @id @default(cuid())
  roomId                String
  userId                String
  role                  VideoRole         @default(PARTICIPANT)
  
  // Media state
  isVideoOn             Boolean           @default(true)
  isAudioOn             Boolean           @default(true)
  isScreenSharing       Boolean           @default(false)
  isHandRaised          Boolean           @default(false)
  
  // Connection
  connectionQuality     ConnectionQuality @default(GOOD)
  
  joinedAt              DateTime          @default(now())
  leftAt                DateTime?

  // Relations
  room                  VideoRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user                  User              @relation("VideoParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@map("video_participants")
}

model VideoRecording {
  id                    String            @id @default(cuid())
  roomId                String
  title                 String?
  filename              String
  fileUrl               String
  fileSize              BigInt?
  duration              Int?              // seconds
  quality               VideoQuality      @default(MEDIUM)
  
  startedAt             DateTime          @default(now())
  endedAt               DateTime?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  // Relations
  room                  VideoRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@map("video_recordings")
}

model VideoChatMessage {
  id                    String            @id @default(cuid())
  roomId                String
  userId                String
  message               String
  type                  ChatMessageType   @default(MESSAGE)
  
  // File sharing
  fileUrl               String?
  fileName              String?
  fileSize              BigInt?
  
  createdAt             DateTime          @default(now())

  // Relations
  room                  VideoRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user                  User              @relation("VideoChatUsers", fields: [userId], references: [id], onDelete: Cascade)

  @@map("video_chat_messages")
}

enum VideoQuality {
  LOW
  MEDIUM
  HIGH
  HD
}

enum RoomStatus {
  WAITING
  ACTIVE
  ENDED
}

enum VideoRole {
  HOST
  MODERATOR
  PARTICIPANT
}

enum ConnectionQuality {
  POOR
  FAIR
  GOOD
  EXCELLENT
}

enum ChatMessageType {
  MESSAGE
  SYSTEM
  FILE
}

(()=>{var e={};e.id=4024,e.ids=[4024],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},20555:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>S,routeModule:()=>m,serverHooks:()=>g,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>I});var s={};r.r(s),r.d(s,{POST:()=>p});var n=r(36639),i=r(99880),o=r(77991),a=r(43831),u=r(11246),c=r(38605),d=r(37086);async function p(e){let t,r=await e.text(),s=(await (0,a.headers)()).get("Stripe-Signature");try{t=c._.webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return new u.NextResponse(`Webhook error: ${e.message}`,{status:400})}let n=t.data.object;if("checkout.session.completed"===t.type){if(!n?.metadata?.type)return new u.NextResponse(null,{status:200});let e=n.metadata;"live_session"===e.type?await l(n):"course_enrollment"===e.type&&await _(n)}return new u.NextResponse(null,{status:200})}async function l(e){let t=e.metadata;try{let r=await d.z.sessionBooking.findFirst({where:{stripeSessionId:e.id,status:"pending"},include:{session:!0}});if(!r)return void console.error("No pending booking found for session:",e.id);await d.z.sessionBooking.update({where:{id:r.id},data:{status:"confirmed",stripePaymentIntentId:e.payment_intent,paymentCompletedAt:new Date}}),await d.z.liveSession.update({where:{id:r.sessionId},data:{status:"scheduled",stripeSessionId:e.id}});let s=Math.round(.15*r.amount),n=r.amount-s;await d.z.commission.create({data:{teacherId:t.teacherId,sessionId:r.sessionId,type:"LiveSession",amount:r.amount,commission:s,netAmount:n,status:"Pending"}}),console.log(`Live session booking confirmed: ${r.id}`)}catch(e){console.error("Error processing live session payment:",e)}}async function _(e){let t=e.metadata;try{if(!t.userId||!t.courseId)throw Error("Missing metadata for course enrollment");await d.z.enrollment.update({where:{userId_courseId:{userId:t.userId,courseId:t.courseId}},data:{status:"Active"}}),await d.z.course.update({where:{id:t.courseId},data:{totalStudents:{increment:1}}});let e=await d.z.course.findUnique({where:{id:t.courseId}});if(e){let t=Math.round(.1*e.price),r=e.price-t;await d.z.commission.create({data:{teacherId:e.userId,courseId:e.id,type:"Course",amount:e.price,commission:t,netAmount:r,status:"Pending"}})}console.log(`Course enrollment confirmed: ${t.courseId} for user: ${t.userId}`)}catch(e){console.error("Error processing course enrollment payment:",e)}}let m=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/sanket/Documents/LMS-Organomed copy/app/api/webhooks/stripe/route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:E,workUnitAsyncStorage:I,serverHooks:g}=m;function S(){return(0,o.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:I})}},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},35979:()=>{},37086:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var s=r(96330);let n=global.prisma||new s.PrismaClient},38605:(e,t,r)=>{"use strict";r.d(t,{_:()=>o});var s=r(99507),n=r(94149);let i=process.env.SKIP_ENV_VALIDATION?"sk_test_dummy_key_for_build":n._.STRIPE_SECRET_KEY,o=new s.A(i,{apiVersion:"2025-05-28.basil",typescript:!0})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},94149:(e,t,r)=>{"use strict";r.d(t,{_:()=>i});var s=r(97191),n=r(79082);let i=(0,s.w)({server:{DATABASE_URL:n.z.string().url(),BETTER_AUTH_SECRET:n.z.string().min(1),BETTER_AUTH_URL:n.z.string().url(),AUTH_GITHUB_CLIENT_ID:n.z.string().min(1),AUTH_GITHUB_SECRET:n.z.string().min(1),EMAIL_SERVICE:n.z.string().optional(),EMAIL_HOST:n.z.string().optional(),EMAIL_PORT:n.z.string().optional(),EMAIL_SECURE:n.z.string().optional(),EMAIL_USER:n.z.string().optional(),EMAIL_PASS:n.z.string().optional(),EMAIL_FROM:n.z.string().optional(),AWS_ACCESS_KEY_ID:n.z.string().min(1),AWS_SECRET_ACCESS_KEY:n.z.string().min(1),AWS_ENDPOINT_URL_S3:n.z.string().min(1),AWS_ENDPOINT_URL_IAM:n.z.string().min(1),AWS_REGION:n.z.string().min(1),STRIPE_SECRET_KEY:n.z.string().min(1),STRIPE_WEBHOOK_SECRET:n.z.string().min(1)},skipValidation:!!process.env.SKIP_ENV_VALIDATION,client:{NEXT_PUBLIC_S3_BUCKET_NAME_IMAGES:n.z.string().min(1)},experimental__runtimeEnv:{NEXT_PUBLIC_S3_BUCKET_NAME_IMAGES:"placeholder-bucket"}})},94735:e=>{"use strict";e.exports=require("events")},95651:()=>{},96330:e=>{"use strict";e.exports=require("@prisma/client")},97169:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{describeHasCheckingStringProperty:function(){return n},describeStringPropertyAccess:function(){return s},wellKnownProperties:function(){return i}});let r=/^[A-Za-z_$][A-Za-z0-9_$]*$/;function s(e,t){return r.test(t)?"`"+e+"."+t+"`":"`"+e+"["+JSON.stringify(t)+"]`"}function n(e,t){let r=JSON.stringify(t);return"`Reflect.has("+e+", "+r+")`, `"+r+" in "+e+"`, or similar"}let i=new Set(["hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toString","valueOf","toLocaleString","then","catch","finally","status","displayName","toJSON","$$typeof","__esModule"])}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7991,2692,3831,4714,5715],()=>r(20555));module.exports=s})();